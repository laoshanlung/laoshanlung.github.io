<!DOCTYPE html>
<html>
    <head>
      <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Use transclusion to implement template blocks in Angular</title>
<meta name="viewport" content="width=device-width">
<link rel="shortcut icon" href="/favicon.ico?v=2" />

<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/flatly.min.css">

<!-- syntax highlighting CSS -->
<link rel="stylesheet" href="/css/pygments.native.css">
<link rel="stylesheet" href="/css/syntax.css">

<!-- Custom CSS -->
<link rel="stylesheet" href="/css/main.css">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.min.js"></script>
    </head>
    <body>
      <div class="navbar navbar-default navbar-static-top" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="/">Tan Nguyen</a>
  </div>

  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse navbar-ex1-collapse">
    <ul class="nav navbar-nav ">
      
        
        <li>
        
          <a href="/index.html">Home</a>
        </li>
      
        
        <li>
        
          <a href="/about.html">About</a>
        </li>
      
      <!-- Begin tags -->
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
        <ul class="dropdown-menu">
         
          <li>
          <a href="/tag/javascript.html">javascript</a>
          </li>
          
          <li>
          <a href="/tag/angular.html">angular</a>
          </li>
          
          <li>
          <a href="/tag/python.html">python</a>
          </li>
          
          <li>
          <a href="/tag/flask.html">flask</a>
          </li>
          
          <li>
          <a href="/tag/api.html">api</a>
          </li>
          
        </ul>
      </li>
      <!-- End tags -->
    </ul>
    <!-- Begin Pagination -->
    

    
    <!-- End pagination -->
  </div><!-- /.navbar-collapse -->
</div>

      <div class="container">
        <h1>Use transclusion to implement template blocks in Angular</h1>
<p class="meta">
  <span class="label label-default">19 Jul 2015</span>
  
  <span class="label label-info">
  <a href="/tag/javascript.html">javascript</a>
  </span>
  
  <span class="label label-info">
  <a href="/tag/angular.html">angular</a>
  </span>
  
</p>

<div class="post">
<p>Transclusion can be very confusing at first but when I get to know the basic concept of it in Angular, things get more and more interesting. With the use of <code>transclude</code> in directives, I can implement a lot of cool stuf, one of those things is to have a directive that accepts different blocks of content.</p>

<p>It is similar to the concept of blocks in many template engines such as  Jinja2 in Python or Swig in Nodejs. The use case for this kind of structure is to provide a basic template and accept custom markup in order to build the final output. In this post, I will skip the basic concept of transclusion in Angular because it has been explained in many places.</p>

<p>Few weeks ago, I wanted to have a popover (the one included in <a href="http://getbootstrap.com/javascript/#popovers">Bootstrap</a>). The problem was that a popover component consists of 2 parts, the trigger (button, link etc...) and the actual popover content. I needed to put the popover component in a table generated by <code>ng-repeat</code> and use different text for the trigger and different data for the content based on the current item. At first, I was thinking about a specific directive to just show what needs to be shown in this particular table</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;specific-popover</span> <span class="na">trigger-text=</span><span class="s">"{{ item.name }}"</span>
                  <span class="na">content-text=</span><span class="s">"{{ item.name }}"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/specific-popover&gt;</span></code></pre></div>

<p>Well, it worked, but I didn&#39;t like it because if I want to have a different markup for the content and/or the trigger element for another table, I need to implement a new directive and copy/paste most stuff from <code>specific-popover</code>. It is against D.R.Y principle. Then, I came up with a simple solution using transclusion.</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;general-popover&gt;</span>
    <span class="nt">&lt;popover-trigger&gt;&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-primary btn-xs"</span><span class="nt">&gt;</span>{{ item.name }}<span class="nt">&lt;/button&gt;&lt;/popover-trigger&gt;</span>
    <span class="nt">&lt;popover-content&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Hello! {{ item.name }}<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/popover-content&gt;</span>
<span class="nt">&lt;/general-popover&gt;</span></code></pre></div>

<p>It is longer but it&#39;s worth the extra typing effort. With this directive, I can reuse it whenever I need a popover. All I need to do is to provide the suitable templates for the trigger and the content part. In fact, this kind of structure has been used a lot, for example in <a href="https://github.com/angular-ui/ui-select">ui-select</a>, we have <code>ui-select-match</code> and <code>ui-select-choices</code> nested inside the main <code>ui-select</code> directive.</p>

<h2>The parent directive</h2>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myapp'</span><span class="p">).</span><span class="nx">directive</span><span class="p">(</span><span class="s1">'generalPopover'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="na">controller</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$element</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

            <span class="nx">self</span><span class="p">.</span><span class="nx">setTrigger</span> <span class="o">=</span> <span class="nx">setTrigger</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">getTrigger</span> <span class="o">=</span> <span class="nx">getTrigger</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">setContent</span> <span class="o">=</span> <span class="nx">setContent</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">getContent</span> <span class="o">=</span> <span class="nx">getContent</span><span class="p">;</span>

            <span class="kd">function</span> <span class="nx">setTrigger</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">popoverTriggerElm</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">getTrigger</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">popoverTriggerElm</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">setContent</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">popoverContent</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">getContent</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">popoverContent</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">link</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$element</span><span class="p">,</span> <span class="nx">$attrs</span><span class="p">,</span> <span class="nx">controller</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">triggerElm</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">getTrigger</span><span class="p">();</span>
            <span class="nx">$element</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">triggerElm</span><span class="p">);</span>

            <span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="nx">$attrs</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">triggerElm</span><span class="p">.</span><span class="nx">popover</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">triggerElm</span><span class="p">.</span><span class="nx">popover</span><span class="p">(</span><span class="s1">'destroy'</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">triggerElm</span><span class="p">.</span><span class="nx">popover</span><span class="p">({</span>
                    <span class="na">html</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="na">content</span><span class="p">:</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">getContent</span><span class="p">(),</span>
                    <span class="na">placement</span><span class="p">:</span> <span class="nx">newValue</span><span class="p">.</span><span class="nx">placement</span> <span class="o">||</span> <span class="s1">'bottom'</span><span class="p">,</span>
                    <span class="na">trigger</span><span class="p">:</span> <span class="nx">newValue</span><span class="p">.</span><span class="nx">trigger</span> <span class="o">||</span> <span class="s1">'click'</span>
                <span class="p">});</span>
            <span class="p">});</span>

            <span class="nx">$scope</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="s1">'$destroy'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">triggerElm</span><span class="p">.</span><span class="nx">popover</span><span class="p">(</span><span class="s1">'destroy'</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">};</span>

<span class="p">});</span></code></pre></div>

<p>There is nothing special about this directive, the controller exposes several methods to get/set the content and the trigger element. Then <code>$watch</code> is used to monitor changes happened to the provided <code>options</code>. I don&#39;t use isolate scope or child scope because later on the other directives, I need to compile them against the current scope to use existing variables and functions from the outer scope. In this simple implementation, I just destroy the old popover and create a new one whenever there are changes detected.</p>

<h2>The content and trigger</h2>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myapp'</span><span class="p">).</span><span class="nx">directive</span><span class="p">(</span><span class="s1">'popoverTrigger'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="na">require</span><span class="p">:</span> <span class="s1">'^generalPopover'</span><span class="p">,</span>
        <span class="na">transclude</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">link</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$element</span><span class="p">,</span> <span class="nx">$attrs</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">,</span> <span class="nx">$transclude</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$transclude</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">clone</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">ctrl</span><span class="p">.</span><span class="nx">setTrigger</span><span class="p">(</span><span class="nx">clone</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">};</span>

<span class="p">}).</span><span class="nx">directive</span><span class="p">(</span><span class="s1">'popoverContent'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="na">require</span><span class="p">:</span> <span class="s1">'^generalPopover'</span><span class="p">,</span>
        <span class="na">transclude</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">link</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$element</span><span class="p">,</span> <span class="nx">$attrs</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">,</span> <span class="nx">$transclude</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$transclude</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">clone</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">ctrl</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">clone</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">};</span>

<span class="p">});</span></code></pre></div>

<p>Those 2 directives are almost identical, the only difference is that they call different methods from the parent controller to set the content. Because of the way angular processes nested directives, we can safely process and pass the content from child directives to parent directive. In this case, the process is as following</p>

<ul>
<li>Call controller of <code>generalPopover</code></li>
<li>Call link of <code>popoverTrigger</code> and pass the controller instance of <code>generalPopover</code> due to the <code>require</code> attribute</li>
<li>Call link of <code>popoverContent</code> and pass the controller instance of <code>generalPopover</code> due to the <code>require</code> attribute</li>
<li>The link functions of child directives then process the transcluded content and pass it to <code>generalPopover</code> through <code>setTrigger</code> and <code>setContent</code></li>
<li>Call link of <code>generalPopover</code> and start the final rendering process using the transcluded content passed by <code>popoverTrigger</code> and <code>popoverContent</code></li>
</ul>

<p>There is one thing to note here is how all 3 directives work in the same scope. This enables the content and the trigger to access all the variables and functions of the outer scope.</p>

<p>This is just a naive implementation that I put together to demonstrate the solution. There are other better solutions such as <a href="https://material.angularjs.org/latest/#/">angular-material</a> which uses this kind of structure a lot.</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    // Required: on line below, replace text in quotes with your forum shortname
    var disqus_shortname = "tan-nguyen";
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
      </div>

    </body>
</html>
